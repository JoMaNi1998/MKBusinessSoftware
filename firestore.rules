rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // Helper Functions
    // ==========================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isProjektleiterOrAdmin() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'projektleiter');
    }

    // ==========================================
    // ADMIN: Vollzugriff auf ALLES
    // ==========================================
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ==========================================
    // MONTEUR-ZUGRIFF: Diese 5 Collections sind für alle authentifizierten User
    // (projects, materials, bookings, vde-protocols, project-photos)
    // ==========================================

    // Projekte (alle authentifizierten User - Monteur sieht nur zugewiesene via Frontend)
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isAuthenticated();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Materialien (alle authentifizierten User)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isAuthenticated();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Buchungen/Lagerbewegungen (alle authentifizierten User)
    match /bookings/{bookingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isProjektleiterOrAdmin();
    }

    // VDE-Protokolle (alle authentifizierten User)
    match /vde-protocols/{protocolId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Projekt-Fotos (alle authentifizierten User)
    match /project-photos/{photoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // BOM Erledigte Items - Monteur Stückliste Durchstreichen (alle authentifizierten User)
    match /bom-completed-items/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ==========================================
    // NUR PROJEKTLEITER/ADMIN: Folgende Collections
    // ==========================================

    // Kunden (nur Projektleiter/Admin)
    match /customers/{customerId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Angebote (nur Projektleiter/Admin)
    match /offers/{offerId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Rechnungen (nur Projektleiter/Admin)
    match /invoices/{invoiceId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Kategorien (nur Projektleiter/Admin)
    match /categories/{categoryId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Spezifikationen (nur Projektleiter/Admin)
    match /specifications/{specId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Konfigurationen (nur Projektleiter/Admin)
    match /configurations/{configId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // ==========================================
    // Settings - Nur Admins dürfen schreiben
    // ==========================================

    // Kalkulationseinstellungen
    match /calculation-settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Firmeneinstellungen
    match /company-settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ==========================================
    // User-spezifische Daten
    // ==========================================

    // User Dokumente
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // User Preferences - nur eigene
    match /user-preferences/{prefId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      // Optional: Stricter - nur eigene Preferences
      // allow read, write: if isAuthenticated() && prefId.matches('.*-' + request.auth.uid);
    }

    // ==========================================
    // Counter Dokumente (für Nummern-Generierung)
    // ==========================================

    // Counter werden für Nummern-Generierung benötigt (nur Projektleiter/Admin)
    match /counters/{counterId} {
      allow read: if isProjektleiterOrAdmin();
      allow write: if isProjektleiterOrAdmin();
    }

    // ==========================================
    // Audit Logs (Optional für Zukunft)
    // ==========================================

    match /audit-logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Nur via Cloud Functions
    }

    // ==========================================
    // Service Catalog und PV-Konfigurationen
    // ==========================================

    // Service Catalog (Leistungskatalog)
    match /service-catalog/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // PV-Konfigurationen (nur Projektleiter/Admin)
    match /pv-configurations/{configId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // Projekt-Konfigurationen (nur Projektleiter/Admin)
    match /project-configurations/{configId} {
      allow read: if isProjektleiterOrAdmin();
      allow create: if isProjektleiterOrAdmin();
      allow update: if isProjektleiterOrAdmin();
      allow delete: if isProjektleiterOrAdmin();
    }

    // PV-Defaults (Standard-Einstellungen für PV-Konfigurator)
    match /pv-defaults/{defaultId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ==========================================
    // Fallback - Nicht-Admins: Alles andere blockieren
    // ==========================================
    // (Admins haben bereits oben Vollzugriff)
  }
}
